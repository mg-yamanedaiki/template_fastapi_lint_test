version: 2.1

executors:
  ubuntu:
    machine:
      image: ubuntu-2004:current
  python:
    docker:
      - image: cimg/python:3.9.12

jobs:
  test:
    executor: ubuntu
    shell: /bin/bash
    working_directory: ~/app
    steps:
      - checkout
      - run:
          name: docker-compose build
          command: docker-compose build
      - run:
          name: docker-compose up -d
          command: docker-compose up -d
      - run:
          name: docker-compose ps
          command: docker-compose ps
      - run:
          name: docker-compose exec app poetry --version
          command: docker-compose exec app poetry --version
      - run:
          name: docker-compose exec app poetry install --no-ansi
          command: docker-compose exec app poetry install --no-ansi
      - run:
          name: docker-compose exec app python --version
          command: docker-compose exec app python --version
      - run:
          name: ls -l
          command: ls -l
      - run:
          name: テスト実行
          command: docker-compose exec app poetry run inv lint
      - persist_to_workspace:
          root: .
          paths:
            - .

  lint:
    executor: python
    shell: /bin/bash
    working_directory: ~/app
    steps:
      - checkout
      - run:
          name: poetry install
          command: poetry install
      - run:
          name: poetry run inv lint
          command: poetry run inv lint || echo "mypy failed" && exit 1

  deploy-dev:
    executor: ubuntu
    shell: /bin/bash
    working_directory: ~/app
    steps:
      - attach_workspace:
          at: ~/app
      - add_ssh_keys
      - run:
          name: SSHで最新状態を適用
          command: >
            ssh ${USER_NAME}@${HOST_NAME} "cd ~/workspace/atd_00_template_api_python && ./scripts/deploy-develop.sh"
workflows:
  lint_deploy:
    jobs:
      # - setup:
      #     filters:
      #       branches:
      #         ignore:
      #           - main
      #           - master
      #           - develop
      - lint:
          # requires:
          #   - setup
          filters:
            branches:
              ignore:
                - main
                - master
                - develop
      - deploy-dev:
          filters:
            branches:
              only:
                - develop
